name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - "src/main/java/**"
      - "src/test/java/**"
      - "build.gradle"
      - ".github/workflows/backend-deploy.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/main/java/**"
      - "src/test/java/**"
      - "build.gradle"
      - ".github/workflows/backend-deploy.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle (React ë¹Œë“œ ì‹œ ê²½ê³  ë¬´ì‹œ)
        run: CI=false DISABLE_ESLINT_PLUGIN=true ./gradlew build -x test

      - name: Run tests
        run: ./gradlew test

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build JAR
        run: CI=false DISABLE_ESLINT_PLUGIN=true ./gradlew bootJar

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Open SSH (í¬íŠ¸ 22 ì„ì‹œ ì—´ê¸°)
        run: |
          echo "âœ… í¬íŠ¸ 22 ì„ì‹œ ê°œë°© (0.0.0.0/0)"
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp --port 22 \
            --cidr 0.0.0.0/0 \
            || echo "í¬íŠ¸ê°€ ì´ë¯¸ ì—´ë ¤ìˆìŒ"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: mooddisk-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          KEY: ${{ secrets.EC2_SSH_KEY }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: mooddisk-backend
          IMAGE_TAG: ${{ github.sha }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          echo "$KEY" | base64 -d > private_key.pem
          chmod 600 private_key.pem

          echo "âœ… EC2ì— ì ‘ì†í•˜ì—¬ AWS CLI ì„¤ì¹˜ ë° Docker ë°°í¬"

          # Create AWS credentials command
          CREDS_CMD="mkdir -p ~/.aws && echo '[default]' > ~/.aws/credentials && echo 'aws_access_key_id=${AWS_ACCESS_KEY}' >> ~/.aws/credentials && echo 'aws_secret_access_key=${AWS_SECRET_KEY}' >> ~/.aws/credentials && echo 'region=ap-northeast-2' >> ~/.aws/credentials"

          # Execute deployment
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} "
            if ! command -v aws &> /dev/null; then
              sudo apt-get update
              sudo apt-get install -y curl unzip
              curl 'https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip' -o 'awscliv2.zip'
              unzip awscliv2.zip
              sudo ./aws/install
              rm -rf awscliv2.zip aws
            fi
            ${CREDS_CMD}
            aws --version
            
            # Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            echo '=== Disk usage before cleanup ==='
            df -h
            echo '=== Cleaning up unused Docker resources ==='
            docker system prune -a --volumes -f || true
            echo '=== Disk usage after cleanup ==='
            df -h
            
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ${ECR_REGISTRY}
            
            # Blue-Green ë°°í¬: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë°±ì—… (ì¤‘ì§€ë§Œ í•˜ê³  ì‚­ì œí•˜ì§€ ì•ŠìŒ)
            echo '=== Blue-Green Deployment: Backing up existing container ==='
            HAS_OLD_CONTAINER=false
            if docker ps -a | grep -q 'mooddisk-backend$'; then
              HAS_OLD_CONTAINER=true
              docker stop mooddisk-backend || true
              docker rm mooddisk-backend-old 2>/dev/null || true
              docker rename mooddisk-backend mooddisk-backend-old 2>/dev/null || echo 'Failed to rename, will use old container directly'
              echo 'âœ… Existing container backed up as mooddisk-backend-old'
            else
              echo 'â„¹ï¸  No existing container to backup'
            fi
            
            # ìƒˆ ì´ë¯¸ì§€ pull
            echo '=== Pulling new image ==='
            docker pull ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo '=== Starting new container ==='
            docker run -d --name mooddisk-backend \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}' \
              -e AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
              -e AWS_S3_BUCKET='${{ secrets.AWS_S3_BUCKET }}' \
              -e AWS_S3_UPLOAD_BUCKET='${{ secrets.AWS_S3_UPLOAD_BUCKET }}' \
              -e AWS_S3_STATIC_BUCKET='${{ secrets.AWS_S3_STATIC_BUCKET }}' \
              -e AWS_REGION='ap-northeast-2' \
              -e KAKAO_REST_API_KEY='${{ secrets.KAKAO_REST_API_KEY }}' \
              -e KAKAO_SECRET_KEY='${{ secrets.KAKAO_SECRET_KEY }}' \
              -e GOOGLE_ID_KEY='${{ secrets.GOOGLE_ID_KEY }}' \
              -e GOOGLE_SECRET_KEY='${{ secrets.GOOGLE_SECRET_KEY }}' \
              -e JWT_SECRET_KEY='${{ secrets.JWT_SECRET_KEY }}' \
              -e DB_URL='${{ secrets.DB_URL }}' \
              -e DB_PORT='${{ secrets.DB_PORT }}' \
              -e DB='${{ secrets.DB }}' \
              -e DB_USER='${{ secrets.DB_USER }}' \
              -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
              --restart unless-stopped \
              ${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}
            
            # Health check (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°)
            echo '=== Waiting for new container to be healthy ==='
            DEPLOYMENT_SUCCESS=false
            for i in {1..30}; do
              sleep 2
              if docker ps | grep -q 'mooddisk-backend$'; then
                # Health check: ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì´ê³  ì‘ë‹µí•˜ëŠ”ì§€ í™•ì¸
                if docker exec mooddisk-backend curl -f http://localhost:8080/api/health > /dev/null 2>&1 || timeout 2 bash -c '</dev/tcp/localhost/8080' > /dev/null 2>&1; then
                  echo \"âœ… New container is healthy! (attempt $i/30)\"
                  DEPLOYMENT_SUCCESS=true
                  break
                else
                  echo \"â³ Waiting for health check... (attempt $i/30)\"
                fi
              else
                echo \"âŒ New container stopped unexpectedly\"
                break
              fi
            done
            
            if [ \"\$DEPLOYMENT_SUCCESS\" = true ]; then
              echo '=== âœ… Deployment successful! Removing old container ==='
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ
              docker stop mooddisk-backend-old || true
              docker rm mooddisk-backend-old || true
              echo 'âœ… Old container removed'
            else
              echo '=== âŒ Deployment failed! Rolling back to previous version ==='
              # ìƒˆ ì»¨í…Œì´ë„ˆ ì‚­ì œ
              docker stop mooddisk-backend || true
              docker rm mooddisk-backend || true
              
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë³µêµ¬
              if [ \"\$HAS_OLD_CONTAINER\" = true ] && docker ps -a | grep -q mooddisk-backend-old; then
                docker rename mooddisk-backend-old mooddisk-backend
                docker start mooddisk-backend
                echo 'âœ… Rolled back to previous version'
              else
                echo 'âš ï¸  No previous version to rollback to'
              fi
              exit 1
            fi
            
            echo '=== Final container status ==='
            docker ps -a | grep mooddisk-backend
          "

      - name: Close SSH (í¬íŠ¸ 22 ë‹¤ì‹œ ë‹«ê¸° + ìƒíƒœ í™•ì¸)
        if: always()
        continue-on-error: true
        run: |
          echo "ğŸ”’ í¬íŠ¸ 22 ì°¨ë‹¨ (ë‹¤ì‹œ ${{ secrets.EC2_ALLOWED_IP }}/32 ë§Œ í—ˆìš©)"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp --port 22 \
            --cidr 0.0.0.0/0 \
            || echo "0.0.0.0/0 í¬íŠ¸ëŠ” ì´ë¯¸ ì°¨ë‹¨ë¨"

          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --protocol tcp --port 22 \
            --cidr ${{ secrets.EC2_ALLOWED_IP }}/32 \
            || echo "ì´ë¯¸ ë‚´ IPë§Œ í—ˆìš©ë¨"

          echo "ğŸ” í˜„ì¬ ë³´ì•ˆ ê·¸ë£¹ ìƒíƒœ:"
          aws ec2 describe-security-groups --group-id ${{ secrets.EC2_SECURITY_GROUP_ID }} \
            --query "SecurityGroups[*].IpPermissions" --output json

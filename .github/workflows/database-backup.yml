name: Database Backup

on:
  schedule:
    - cron: "0 2 * * *" # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (UTC) - í•œêµ­ì‹œê°„ ì˜¤ì „ 11ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Install MySQL client and network tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client netcat-openbsd

      - name: Test database connection
        run: |
          echo "ğŸ” ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          echo "ğŸ“‹ ì—°ê²° ì •ë³´ í™•ì¸ (ì¼ë¶€ë§Œ í‘œì‹œ):"
          echo "  - Host: ${{ secrets.DB_URL }}"
          echo "  - Port: ${{ secrets.DB_PORT }}"
          echo "  - User: ${{ secrets.DB_USER }}"
          echo "  - Database: ${{ secrets.DB }}"

          # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ (ncë¥¼ ì‚¬ìš©í•˜ì—¬ í¬íŠ¸ í™•ì¸)
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          if timeout 5 nc -zv "${{ secrets.DB_URL }}" "${{ secrets.DB_PORT }}" 2>&1; then
            echo "âœ… í¬íŠ¸ ì—°ê²° ê°€ëŠ¥"
          else
            echo "âŒ í¬íŠ¸ ì—°ê²° ì‹¤íŒ¨"
            echo ""
            echo "âš ï¸ ì—°ê²° ì‹¤íŒ¨ ê°€ëŠ¥í•œ ì›ì¸:"
            echo "  1. ë°ì´í„°ë² ì´ìŠ¤ê°€ private IP/VPC ë‚´ë¶€ì— ìˆì–´ ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€"
            echo "  2. AWS RDS ë³´ì•ˆ ê·¸ë£¹ì—ì„œ GitHub Actions IPë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŒ"
            echo "  3. ë°©í™”ë²½ì—ì„œ í¬íŠ¸ ${{ secrets.DB_PORT }}ê°€ ì°¨ë‹¨ë¨"
            echo "  4. ì˜ëª»ëœ DB_URL ë˜ëŠ” DB_PORT ì„¤ì •"
            echo ""
            echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
            echo "  - AWS RDSì¸ ê²½ìš°: ë³´ì•ˆ ê·¸ë£¹ ì¸ë°”ìš´ë“œ ê·œì¹™ì— GitHub Actions IP ì¶”ê°€"
            echo "  - VPC ë‚´ë¶€ DBì¸ ê²½ìš°: VPN/SSH í„°ë„ ë˜ëŠ” í”„ë¡ì‹œ ì‚¬ìš©"
            echo "  - secretsì˜ DB_URL, DB_PORT í™•ì¸"
            exit 1
          fi

          export MYSQL_PWD="${{ secrets.DB_PASSWORD }}"

          # ì—°ê²° íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ì´ˆ)
          echo "ğŸ”Œ MySQL ì—°ê²° ì‹œë„..."
          mysql \
            --host="${{ secrets.DB_URL }}" \
            --port="${{ secrets.DB_PORT }}" \
            --user="${{ secrets.DB_USER }}" \
            --connect-timeout=10 \
            --execute="SELECT 1;" \
            "${{ secrets.DB }}"

          echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ"

      - name: Create backup
        run: |
          DATE=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="mooddisk_backup_$DATE.sql"
          S3_BUCKET="${{ secrets.AWS_S3_BACKUP_BUCKET }}"

          echo "ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹œì‘..."
          echo "ğŸ“‹ ì—°ê²° ì •ë³´ í™•ì¸:"
          echo "  - Host: ${{ secrets.DB_URL }}"
          echo "  - Port: ${{ secrets.DB_PORT }}"
          echo "  - User: ${{ secrets.DB_USER }}"
          echo "  - Database: ${{ secrets.DB }}"

          # í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ì—¬ ë³´ì•ˆ ê°•í™”
          export MYSQL_PWD="${{ secrets.DB_PASSWORD }}"

          # mysqldump ëª…ë ¹ì–´ ì‹¤í–‰
          mysqldump \
            --host="${{ secrets.DB_URL }}" \
            --port="${{ secrets.DB_PORT }}" \
            --user="${{ secrets.DB_USER }}" \
            --connect-timeout=10 \
            --single-transaction \
            --routines \
            --triggers \
            "${{ secrets.DB }}" > "$BACKUP_FILE"

          # ë°±ì—… íŒŒì¼ ìƒì„± í™•ì¸
          if [ ! -f "$BACKUP_FILE" ] || [ ! -s "$BACKUP_FILE" ]; then
            echo "âŒ ë°±ì—… íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

          echo "ğŸ“¦ S3ì— ì—…ë¡œë“œ ì¤‘..."
          aws s3 cp "$BACKUP_FILE" "s3://$S3_BUCKET/database/"

          echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_FILE"
          echo "ğŸ“ S3 ìœ„ì¹˜: s3://$S3_BUCKET/database/$BACKUP_FILE"

          # ë°±ì—… íŒŒì¼ í¬ê¸° í™•ì¸
          ls -la "$BACKUP_FILE"

      - name: Cleanup old backups
        run: |
          echo "ğŸ§¹ ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ ì‹œì‘..."

          S3_BUCKET="${{ secrets.AWS_S3_BACKUP_BUCKET }}"
          RETENTION_DAYS="30"  # 30ì¼ ë³´ì¡´ ì •ì±…

          # ì„¤ì •ëœ ê¸°ê°„ ì´ìƒ ëœ ë°±ì—… íŒŒì¼ ì‚­ì œ
          aws s3 ls s3://$S3_BUCKET/database/ --recursive | while read -r line; do
            createDate=$(echo $line | awk '{print $1" "$2}')
            createDate=$(date -d"$createDate" +%s)
            olderThan=$(date -d"$RETENTION_DAYS days ago" +%s)
            fileName=$(echo $line | awk '{print $4}')
            
            if [[ $createDate -lt $olderThan ]]; then
              echo "ğŸ—‘ï¸ ì‚­ì œ ëŒ€ìƒ: $fileName"
              aws s3 rm s3://$S3_BUCKET/database/$fileName
            fi
          done

          echo "âœ… ë°±ì—… íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

          # í˜„ì¬ ë°±ì—… íŒŒì¼ ëª©ë¡ í™•ì¸
          echo "ğŸ“‹ í˜„ì¬ ë°±ì—… íŒŒì¼ ëª©ë¡:"
          aws s3 ls s3://$S3_BUCKET/database/ --human-readable
